<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SusanAI Online</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="background-container">
    <img id="bgImage" src="" alt="Background" />
    <canvas id="effectCanvas"></canvas>
</div>

<!-- UI -->
<div id="videoContainer">
    <video src="intro.mp4" autoplay muted></video>
    <button id="skipButton">‡∏Ç‡πâ‡∏≤‡∏°</button>
</div>

<div id="mainAppContainer" style="display:none">
    <div id="userSection">
        <button id="loginBtn">Login</button>
    </div>
    <div id="userInfo" class="hidden">
        <span id="usernameDisplay"></span>
        <button id="logoutBtn">Logout</button>
        <span>WLD Balance: <span id="wldBalanceEl">0</span></span>
        <span>Susan Points: <span id="susanPointsEl">0</span></span>
    </div>

    <textarea id="memorialText"></textarea>
    <button id="saveMemorialBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>

    <div id="transactionListEl"></div>

    <!-- Activity Modal -->
    <div id="activityModal" style="display:none">
        <div id="activityStartDiv">
            <input type="number" id="waterAmountInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"/>
            <button id="startActivityBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
        </div>
        <div id="activityProgressDiv" class="hidden">
            <span id="activityTimerEl">00:00:00</span>
            <span id="activityPointsEl">0</span>
            <span id="activityRewardEl">0</span>
            <button id="endActivityBtn">‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
        </div>
    </div>

    <!-- Flower Modal -->
    <div id="flowerModal" style="display:none">
        <button id="closeFlowerModalBtn">‡∏õ‡∏¥‡∏î</button>
    </div>

    <button id="buyFlowerButton">‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ 10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>

    <!-- Background Buttons -->
    <div id="backgroundButtonsContainer">
        <button data-bg="eyepp">Eyepp</button>
        <button data-bg="pandorap">Pandora</button>
        <button data-bg="yasup">Yasup</button>
        <button data-bg="bhuddhap">Bhuddhap</button>
        <button data-bg="talep">Talep</button>
        <button data-bg="prasatp">Prasatp</button>
    </div>

    <!-- Sound Controls -->
    <button id="soundToggleBtn"><span id="soundOnIcon" class="hidden">üîä</span><span id="soundOffIcon">üîá</span></button>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01" />

    <!-- Exchange WLD -->
    <input type="number" id="wldAmountInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô WLD">
    <button id="exchangeBtn">‡πÅ‡∏•‡∏Å WLD ‡πÄ‡∏õ‡πá‡∏ô Susan Points</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.worldcoin.org/idkit" defer></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- Firebase Init ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- State ---
    let state = {
        isLoggedIn: false,
        user: { userId:null, worldId:null, worldIdFull:null, susanPoints:500, wldBalance:10, transactions:[], memorial:"" },
        activity: { isActive:false, startTime:null, pointsCommitted:0 },
        sound: { isPlaying:false, volume:0.5 }
    };

    // --- Elements ---
    const bgImage = document.getElementById('bgImage');
    const effectCanvas = document.getElementById('effectCanvas');
    const ctx = effectCanvas.getContext('2d');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const usernameDisplay = document.getElementById('usernameDisplay');
    const wldBalanceEl = document.getElementById('wldBalanceEl');
    const susanPointsEl = document.getElementById('susanPointsEl');
    const memorialText = document.getElementById('memorialText');
    const saveMemorialBtn = document.getElementById('saveMemorialBtn');
    const transactionListEl = document.getElementById('transactionListEl');
    const skipButton = document.getElementById('skipButton');
    const videoContainer = document.getElementById('videoContainer');
    const mainAppContainer = document.getElementById('mainAppContainer');
    const activityModal = document.getElementById('activityModal');
    const activityStartDiv = document.getElementById('activityStartDiv');
    const activityProgressDiv = document.getElementById('activityProgressDiv');
    const activityTimerEl = document.getElementById('activityTimerEl');
    const activityPointsEl = document.getElementById('activityPointsEl');
    const activityRewardEl = document.getElementById('activityRewardEl');
    const startActivityBtn = document.getElementById('startActivityBtn');
    const endActivityBtn = document.getElementById('endActivityBtn');
    let activityInterval;
    const flowerModal = document.getElementById('flowerModal');
    const closeFlowerModalBtn = document.getElementById('closeFlowerModalBtn');
    const buyFlowerButton = document.getElementById('buyFlowerButton');
    const backgroundButtonsContainer = document.getElementById('backgroundButtonsContainer');
    const soundToggleBtn = document.getElementById('soundToggleBtn');
    const soundOnIcon = document.getElementById('soundOnIcon');
    const soundOffIcon = document.getElementById('soundOffIcon');
    const volumeSlider = document.getElementById('volumeSlider');
    const backgroundAudio = new Audio('background.mp3'); backgroundAudio.loop = true; backgroundAudio.volume=0.5;
    const exchangeBtn = document.getElementById('exchangeBtn');
    const wldAmountInput = document.getElementById('wldAmountInput');

    // --- Canvas / Effects ---
    function resizeCanvas(){ effectCanvas.width=window.innerWidth; effectCanvas.height=window.innerHeight; }
    window.addEventListener('resize',resizeCanvas); resizeCanvas();
    function clearCanvas(){ ctx.clearRect(0,0,effectCanvas.width,effectCanvas.height); }
    // [‡πÉ‡∏™‡πà init/draw Stars, Petals, Bubbles, Water, Glow ‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°]

    let animationFrameId, activeEffect;
    function animateLoop(){ if(activeEffect) activeEffect(); animationFrameId=requestAnimationFrame(animateLoop); }

    // --- UI Update / Transactions ---
    function updateUI(){
        usernameDisplay.textContent = state.user.worldId || state.user.userId;
        wldBalanceEl.textContent = state.user.wldBalance.toFixed(2);
        susanPointsEl.textContent = state.user.susanPoints;
        memorialText.value = state.user.memorial;
        transactionListEl.innerHTML = state.user.transactions.map(tx=>`<div class="${tx.amount>0?'text-green-400':'text-red-400'}">${tx.desc}: ${tx.amount.toFixed(2)} Points</div>`).join('');
    }
    function addTransaction(desc,amount){ state.user.transactions.unshift({desc,amount,date:new Date().toISOString()}); if(state.user.transactions.length>20) state.user.transactions.pop(); }

    // --- Firebase Load / Save ---
    async function saveData(userId,data){ if(!userId) return; await db.collection('users').doc(userId).set(data,{merge:true}); }
    async function loadData(userId){ 
        if(!userId) return null;
        const doc=await db.collection('users').doc(userId).get();
        if(doc.exists) return doc.data();
        const defaultData={ susanPoints:500, wldBalance:10, transactions:[], memorial:"" };
        await saveData(userId,defaultData);
        return defaultData;
    }

    // --- World ID Integration ---
    function setupWorldIDButton(){
        let attempts=0; const maxAttempts=50;
        const interval=setInterval(()=>{
            if(typeof IDKit!=='undefined'){
                clearInterval(interval);
                loginBtn.disabled=false; loginBtn.textContent='‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö World ID';
                loginBtn.addEventListener('click', ()=>{ IDKit.open({
                    app_id:"app_57493e6e2fb2153a6a50c98e358b4785",
                    action:"login",
                    onSuccess:(proof)=>{ handleLogin(proof); alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); },
                    onError:(err)=>{ console.error(err); alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô"); }
                }); });
            }else{ attempts++; if(attempts>maxAttempts){ clearInterval(interval); loginBtn.textContent='World ID ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'; } }
        },100);
    }

    async function handleLogin(worldIdProof=null){
        let userCredential; if(auth.currentUser) userCredential={user:auth.currentUser}; else userCredential=await auth.signInAnonymously();
        const userId=userCredential.user.uid;
        state.isLoggedIn=true; state.user.userId=userId;
        if(worldIdProof){ state.user.worldId=worldIdProof.nullifier_hash.slice(0,12); state.user.worldIdFull=worldIdProof.nullifier_hash; }
        else state.user.worldId="@winai.9407";
        const loadedData=await loadData(userId); if(loadedData) state.user={...state.user,...loadedData};
        updateUI();
        mainAppContainer.style.display='block'; videoContainer.style.display='none';
    }

    async function handleLogout(){
        await saveData(state.user.userId,state.user); await auth.signOut();
        state.isLoggedIn=false;
        state.user={ userId:null, worldId:null, worldIdFull:null, susanPoints:500, wldBalance:10, transactions:[], memorial:"" };
        updateUI();
    }

    // --- Event Listeners ---
    skipButton.addEventListener('click',()=>{ mainAppContainer.style.display='block'; videoContainer.style.display='none'; });
    logoutBtn.addEventListener('click',handleLogout);
    saveMemorialBtn.addEventListener('click',()=>{ state.user.memorial=memorialText.value; saveData(state.user.userId,{ memorial: state.user.memorial }); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß'); });
    buyFlowerButton.addEventListener('click',()=>{
        if(state.user.susanPoints>=10){ state.user.susanPoints-=10; addTransaction('‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ',-10); updateUI(); saveData(state.user.userId,{ susanPoints:state.user.susanPoints,transactions:state.user.transactions }); flowerModal.style.display='flex'; }
        else alert('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Susan ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠!');
    });
    closeFlowerModalBtn.addEventListener('click',()=>{ flowerModal.style.display='none'; });
    setupWorldIDButton();

    exchangeBtn.addEventListener('click',()=>{
        const wldAmount=parseFloat(wldAmountInput.value);
        if(isNaN(wldAmount)||wldAmount<=0||wldAmount>state.user.wldBalance){ alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô WLD ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
        const points=wldAmount*50; state.user.wldBalance-=wldAmount; state.user.susanPoints+=points; addTransaction(`‡πÅ‡∏•‡∏Å ${wldAmount} WLD`,points);
        updateUI(); saveData(state.user.userId,{ susanPoints:state.user.susanPoints,wldBalance:state.user.wldBalance,transactions:state.user.transactions });
    });

    // --- Activity ---
    startActivityBtn.addEventListener('click',()=>{
        const amount=parseInt(document.getElementById('waterAmountInput').value);
        if(isNaN(amount)||amount<=0||amount>state.user.susanPoints){ alert('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
        state.user.susanPoints-=amount; state.activity={ isActive:true,startTime:Date.now(),pointsCommitted:amount };
        addTransaction('‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏•‡∏π‡∏Å‡∏õ‡πà‡∏≤',-amount); updateUI();
        activityStartDiv.classList.add('hidden'); activityProgressDiv.classList.remove('hidden');
        activityPointsEl.textContent=amount;
        activityInterval=setInterval(updateActivity,1000);
    });

    function updateActivity(){
        if(!state.activity.isActive) return;
        const elapsed=Math.floor((Date.now()-state.activity.startTime)/1000);
        const hours=Math.floor(elapsed/3600).toString().padStart(2,'0');
        const minutes=Math.floor((elapsed%3600)/60).toString().padStart(2,'0');
        const seconds=(elapsed%60).toString().padStart(2,'0');
        activityTimerEl.textContent=`${hours}:${minutes}:${seconds}`;
        const totalRewardPool=60000000,totalWater=12000000;
        const userShare=state.activity.pointsCommitted/totalWater;
        const rewardPerSecond=totalRewardPool/(24*3600);
        const currentReward=userShare*rewardPerSecond*elapsed;
        activityRewardEl.textContent=currentReward.toFixed(2);
    }

    endActivityBtn.addEventListener('click',()=>{
        clearInterval(activityInterval);
        const elapsed=Math.floor((Date.now()-state.activity.startTime)/1000);
        const totalRewardPool=60000000,totalWater=12000000;
        const userShare=state.activity.pointsCommitted/totalWater;
        const rewardPerSecond=totalRewardPool/(24*3600);
        const finalReward=userShare*rewardPerSecond*elapsed;
        state.user.susanPoints+=finalReward;
        addTransaction('‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',finalReward); alert(`‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î! ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${finalReward.toFixed(2)} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`);
        state.activity={isActive:false,startTime:null,pointsCommitted:0};
        activityStartDiv.classList.remove('hidden'); activityProgressDiv.classList.add('hidden');
        updateUI(); saveData(state.user.userId,{ susanPoints:state.user.susanPoints,transactions:state.user.transactions });
    });

    // --- Sound Controls ---
    soundToggleBtn.addEventListener('click',()=>{
        state.sound.isPlaying=!state.sound.isPlaying;
        if(state.sound.isPlaying){ backgroundAudio.play(); soundOnIcon.classList.remove('hidden'); soundOffIcon.classList.add('hidden'); }
        else{ backgroundAudio.pause(); soundOnIcon.classList.add('hidden'); soundOffIcon.classList.remove('hidden'); }
    });
    volumeSlider.addEventListener('input',(e)=>{ state.sound.volume=e.target.value; backgroundAudio.volume=state.sound.volume; });

    updateUI();
});
</script>
</body>
</html>
