<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>FirebirdRE</title>
<style>
  body, html { margin:0; padding:0; overflow:hidden; background:#000; }
  canvas { position:absolute; top:0; left:0; }
  .hidden { display:none; }
  .background-container { position:relative; width:100%; height:100%; }
</style>
</head>
<body>

<div class="background-container">
  <img id="bgImage" src="" style="position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity 0.5s;">
  <canvas id="effectCanvas"></canvas>
</div>

<!-- UI Elements -->
<button id="loginBtn">Login World ID</button>
<button id="logoutBtn">Logout</button>
<button id="skipButton">Skip Intro</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// --- Firebase ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MSG_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// --- State ---
let state = {
  isLoggedIn:false,
  user:{userId:null, worldId:null, susanPoints:500, wldBalance:10, transactions:[], memorial:""},
};

// --- DOM ---
const effectCanvas = document.getElementById('effectCanvas');
const ctx = effectCanvas.getContext('2d');
const bgImage = document.getElementById('bgImage');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const skipButton = document.getElementById('skipButton');

// --- Background Data ---
const backgroundData = {
  eyepp:{src:'https://winaiac.github.io/firebirdre/eyepp.png', effect:'stars'},
  yasup:{src:'https://winaiac.github.io/firebirdre/yasup.png', effect:'petals'}
};

// --- Canvas / Effects ---
let animationFrameId = null;
let activeEffect = null;

function resizeCanvas() { effectCanvas.width = window.innerWidth; effectCanvas.height = window.innerHeight; }
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function clearCanvas(){ctx.clearRect(0,0,effectCanvas.width,effectCanvas.height);}

let stars=[];
function initStars(){stars=Array.from({length:200},()=>({x:Math.random()*effectCanvas.width,y:Math.random()*effectCanvas.height,radius:Math.random()*1.5+0.5,opacity:Math.random()*0.5+0.1,velocity:Math.random()*0.02+0.01}));}
function drawStars(){clearCanvas();stars.forEach(s=>{ctx.beginPath();ctx.arc(s.x,s.y,s.radius,0,Math.PI*2);ctx.fillStyle=`rgba(255,255,255,${s.opacity})`;ctx.fill();s.opacity+=s.velocity;if(s.opacity>0.8||s.opacity<0.1)s.velocity*=-1;});}

let petals=[];
function initPetals(){petals=Array.from({length:50},()=>({x:Math.random()*effectCanvas.width,y:Math.random()*effectCanvas.height,size:Math.random()*10+5,opacity:Math.random()*0.7+0.3,rotation:Math.random()*360,rSpeed:Math.random()*0.02-0.01,xVel:Math.random()*0.5-0.25,yVel:Math.random()*1.5+0.5}));}
function drawPetals(){clearCanvas();petals.forEach(p=>{ctx.beginPath();ctx.fillStyle=`rgba(255,182,193,${p.opacity})`;ctx.ellipse(p.x,p.y,p.size/2,p.size,p.rotation,0,Math.PI*2);ctx.fill();p.x+=p.xVel;p.y+=p.yVel;p.rotation+=p.rSpeed;if(p.y>effectCanvas.height){p.x=Math.random()*effectCanvas.width;p.y=-20;}});}

const effectMap={stars:{init:initStars,draw:drawStars},petals:{init:initPetals,draw:drawPetals}};

function updateBackground(bgKey){
  if(animationFrameId) cancelAnimationFrame(animationFrameId);
  clearCanvas();
  const data = backgroundData[bgKey];
  if(!data) return;
  bgImage.style.opacity=0;
  const img=new Image();
  img.src=data.src;
  img.onload=()=>{
    bgImage.src=data.src;
    bgImage.style.opacity=1;
    const effect=effectMap[data.effect];
    if(effect){effect.init(); activeEffect=effect.draw;} else{activeEffect=null;}
    animateLoop();
  };
}

function animateLoop(){if(activeEffect) activeEffect(); animationFrameId=requestAnimationFrame(animateLoop);}

// --- Firebase Save / Load ---
async function saveData(userId,data){ if(!userId)return; try{await setDoc(doc(db,"users",userId),data,{merge:true});}catch(e){console.error(e);} }
async function loadData(userId){ if(!userId)return null; try{ const docSnap=await getDoc(doc(db,"users",userId)); if(docSnap.exists()){return docSnap.data();}else{const defaultData={susanPoints:500,wldBalance:10,transactions:[],memorial:""};await saveData(userId,defaultData);return defaultData;} }catch(e){console.error(e);return null;}}

// --- Login / Logout ---
async function handleLogin(worldIdProof=null){
  try{
    let userCredential;
    if(auth.currentUser){userCredential={user:auth.currentUser};}else{userCredential=await signInAnonymously(auth);}
    const userId=userCredential.user.uid;
    state.isLoggedIn=true;
    state.user.userId=userId;
    state.user.worldId=worldIdProof?worldIdProof.nullifier_hash.slice(0,12):"@winai.9407";
    const loadedData=await loadData(userId);
    if(loadedData){loadedData.transactions=loadedData.transactions||[]; state.user={...state.user,...loadedData};}
    alert("Login สำเร็จ: "+state.user.worldId);
  }catch(e){console.error(e);}
}
async function handleLogout(){
  await saveData(state.user.userId,state.user);
  await signOut(auth);
  state.isLoggedIn=false;
  state.user={userId:null,worldId:null,susanPoints:500,wldBalance:10,transactions:[],memorial:""};
  alert("Logout สำเร็จ");
}

// --- World ID Button ---
function setupWorldIDButton(){
  let attempts=0;
  const maxAttempts=50;
  const interval=setInterval(()=>{
    if(typeof IDKit!=="undefined"){clearInterval(interval);
      loginBtn.disabled=false; loginBtn.textContent='เข้าสู่ระบบ World ID';
      loginBtn.addEventListener('click',()=>{ IDKit.open({
        app_id:"app_57493e6e2fb2153a6a50c98e358b4785",
        action:"logih",
        onSuccess:(proof)=>{console.log(proof); alert("ยืนยันตัวตนสำเร็จ!"); handleLogin(proof); },
        onError:(err)=>{console.error(err); alert("IDKit Error");}
      });});
    }else{attempts++; if(attempts>maxAttempts){clearInterval(interval);loginBtn.textContent='World ID ล้มเหลว';}}
  },100);
}

setupWorldIDButton();

// --- Skip Intro ---
skipButton.addEventListener('click',()=>{updateBackground('eyepp');});

</script>
</body>
</html>
