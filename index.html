import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'firebase/firestore';

const firebaseConfig = JSON.parse(__firebase_config);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Use a specific document to store the promotion text
const promotionDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'promotions', 'currentPromotion');

// The ID of the first user who logs in will be considered the "admin"
let adminUid = null;

export default function App() {
  const [promotionText, setPromotionText] = useState('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
  const [editorText, setEditorText] = useState('');
  const [currentUser, setCurrentUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [loading, setLoading] = useState(true);
  const [saveStatus, setSaveStatus] = useState('');

  useEffect(() => {
    // Sign in anonymously and check for the admin user
    const signInAndCheckAdmin = async () => {
      try {
        const userCredential = await signInAnonymously(auth);
        const user = userCredential.user;
        setCurrentUser(user);

        // Check if admin user exists in Firestore
        const adminDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'appSettings', 'admin');
        const adminDocSnap = await getDoc(adminDocRef);
        
        if (adminDocSnap.exists()) {
          adminUid = adminDocSnap.data().uid;
        } else {
          // If no admin exists, the current user becomes the admin
          await setDoc(adminDocRef, { uid: user.uid });
          adminUid = user.uid;
        }
        
        setIsAdmin(user.uid === adminUid);
        setLoading(false);
      } catch (error) {
        console.error("Error during authentication or admin check:", error);
        setLoading(false);
      }
    };

    signInAndCheckAdmin();
  }, []);

  useEffect(() => {
    if (!loading) {
      // Listen for real-time changes to the promotion text
      const unsubscribe = onSnapshot(promotionDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          setPromotionText(data.text);
          setEditorText(data.text);
        } else {
          // Set initial default text if document doesn't exist
          const defaultText = `üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©\n‡πÅ‡∏à‡∏Å‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤ 1,900 ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 8 ‡∏Ñ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!\n1. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô World ID\n‡∏Ñ‡∏•‡∏¥‡∏Å: https://world.org/join/OD4QYLW`;
          setPromotionText(defaultText);
          setEditorText(defaultText);
          setDoc(promotionDocRef, { text: defaultText });
        }
      });
      return () => unsubscribe();
    }
  }, [loading]);

  const handleSave = async () => {
    if (!isAdmin) {
      setSaveStatus('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ');
      return;
    }

    setSaveStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
    try {
      await setDoc(promotionDocRef, { text: editorText });
      setSaveStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
    } catch (error) {
      console.error("Error updating document:", error);
      setSaveStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
    }
    setTimeout(() => setSaveStatus(''), 3000);
  };

  return (
    <div className="min-h-screen bg-gray-100 p-8 flex flex-col items-center font-sans">
      <h1 className="text-4xl font-bold mb-8 text-indigo-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h1>
      
      {loading ? (
        <p className="text-center text-lg text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      ) : (
        <>
          {/* Promotion Display Area */}
          <div className="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 className="text-2xl font-semibold mb-4 text-gray-800">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</h2>
            <pre className="text-gray-700 whitespace-pre-wrap leading-relaxed font-sans text-lg">{promotionText}</pre>
          </div>

          {/* Admin Panel */}
          {isAdmin && (
            <div className="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-2xl font-semibold mb-4 text-gray-800">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô (Admin Only)</h2>
              <textarea
                className="w-full h-48 p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-800 font-sans text-base resize-none"
                value={editorText}
                onChange={(e) => setEditorText(e.target.value)}
              />
              <div className="flex justify-between items-center mt-4">
                <button
                  className="bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                  onClick={handleSave}
                >
                  ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                {saveStatus && (
                  <p className={`text-sm font-semibold ${saveStatus.includes('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à') ? 'text-green-600' : 'text-red-600'}`}>
                    {saveStatus}
                  </p>
                )}
              </div>
            </div>
          )}
          
          {/* User Info for debugging */}
          <div className="mt-8 text-center text-gray-500 text-sm">
            <p>User ID: {currentUser?.uid || 'N/A'}</p>
            <p className="text-xs">
              ** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô Admin **
            </p>
          </div>
        </>
      )}
    </div>
  );
}
