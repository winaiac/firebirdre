<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SusanAI Online</title>
<style>
  /* --- Basic UI & Layout --- */
  body, html { margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
  .hidden { display: none; }
  .background-container { position: fixed; top:0; left:0; width:100%; height:100%; overflow:hidden; z-index: -1; }
  canvas { position: absolute; top:0; left:0; }
  .control-panel.visible { opacity: 1; transition: opacity 0.3s; }
  .control-panel { position: fixed; bottom:10px; right:10px; opacity:0; z-index:100; }
</style>
</head>
<body>

<div class="background-container">
  <img id="bgImage" src="" style="width:100%; height:100%; object-fit:cover; position:absolute; top:0; left:0; transition: opacity 0.5s;">
  <canvas id="effectCanvas"></canvas>
</div>

<!-- Video intro -->
<div id="videoContainer">
  <video src="intro.mp4" autoplay></video>
  <button id="skipButton">‡∏Ç‡πâ‡∏≤‡∏°</button>
</div>

<!-- Main App -->
<div id="mainAppContainer" style="display:none;">
  <div id="userSection">
    <button id="loginBtn" disabled>Loading...</button>
  </div>
  <div id="userInfo" class="hidden">
    <span id="usernameDisplay"></span>
    <button id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    <span>WLD: <span id="wldBalanceEl"></span></span>
    <span>Susan Points: <span id="susanPointsEl"></span></span>
  </div>

  <div id="controlPanel" class="control-panel">
    <button id="portfolioBtnNav">Portfolio</button>
    <button id="exchangeBtn">‡πÅ‡∏•‡∏Å WLD</button>
    <button id="activityBtnNav">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
    <button id="buyFlowerButton">‡∏ã‡∏∑‡πâ‡∏≠‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ</button>
    <button id="soundToggleBtn">üîä</button>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.01">
  </div>

  <!-- Transaction List -->
  <div id="transactionListEl"></div>
  <!-- Memorial -->
  <textarea id="memorialText"></textarea>
  <button id="saveMemorialBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

  <!-- Modals -->
  <div id="activityModal" style="display:none;"></div>
  <div id="flowerModal" style="display:none;"></div>

  <!-- Background Buttons -->
  <div id="backgroundButtonsContainer">
    <button data-bg="eyepp">Eye</button>
    <button data-bg="pandorap">Pandora</button>
    <button data-bg="yasup">Yasup</button>
    <button data-bg="bhuddhap">Buddha</button>
    <button data-bg="talep">Talep</button>
    <button data-bg="prasatp">Prasat</button>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

<!-- World ID SDK -->
<script src="https://developer.worldcoin.org/js/world-id-sdk.js"></script>

<script>
window.onload = function() {

  // --- State Management ---
  let state = {
    isLoggedIn: false,
    isLightOn: false,
    isAdmin: false,
    user: { userId: null, worldId: null, susanPoints: 500, wldBalance: 10, transactions: [], memorial: "" },
    activity: { isActive: false, startTime: null, pointsCommitted: 0 },
    sound: { isPlaying: false, volume: 0.5 }
  };

  // --- DOM Elements ---
  const effectCanvas = document.getElementById('effectCanvas');
  const ctx = effectCanvas.getContext('2d');
  const bgImage = document.getElementById('bgImage');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const skipButton = document.getElementById('skipButton');
  const mainAppContainer = document.getElementById('mainAppContainer');
  const videoContainer = document.getElementById('videoContainer');
  const usernameDisplay = document.getElementById('usernameDisplay');
  const userSection = document.getElementById('userSection');
  const userInfo = document.getElementById('userInfo');
  const wldBalanceEl = document.getElementById('wldBalanceEl');
  const susanPointsEl = document.getElementById('susanPointsEl');
  const memorialText = document.getElementById('memorialText');
  const saveMemorialBtn = document.getElementById('saveMemorialBtn');
  const transactionListEl = document.getElementById('transactionListEl');
  const controlPanel = document.getElementById('controlPanel');
  const portfolioBtnNav = document.getElementById('portfolioBtnNav');
  const exchangeBtn = document.getElementById('exchangeBtn');
  const activityBtnNav = document.getElementById('activityBtnNav');
  const activityModal = document.getElementById('activityModal');
  const buyFlowerButton = document.getElementById('buyFlowerButton');
  const flowerModal = document.getElementById('flowerModal');
  const backgroundButtonsContainer = document.getElementById('backgroundButtonsContainer');
  const soundToggleBtn = document.getElementById('soundToggleBtn');
  const volumeSlider = document.getElementById('volumeSlider');

  let animationFrameId = null;
  let activeEffect = null;
  let controlPanelTimeout;
  let activityInterval;
  const backgroundAudio = new Audio("background.mp3");
  const activityStartDiv = document.createElement('div');
  const activityProgressDiv = document.createElement('div');
  const activityPointsEl = document.createElement('span');
  const activityTimerEl = document.createElement('span');
  const activityRewardEl = document.createElement('span');

  // --- Firebase Functions ---
  async function saveData(userId, data) { if(!userId) return; try{ await db.collection('users').doc(userId).set(data, {merge:true}); } catch(e){ console.error(e);} }
  async function loadData(userId) {
    if(!userId) return null;
    try{
      const doc = await db.collection('users').doc(userId).get();
      if(doc.exists) return doc.data();
      const defaultData = { susanPoints:500, wldBalance:10, transactions:[], memorial:"" };
      await saveData(userId, defaultData);
      return defaultData;
    } catch(e){ console.error(e); return null; }
  }

  // --- Background & Effects ---
  const backgroundData = {
    eyepp:{src:'https://winaiac.github.io/firebirdre/eyepp.png', effect:'wind'},
    pandorap:{src:'https://winaiac.github.io/firebirdre/pandorap.png', effect:'stars'},
    yasup:{src:'https://winaiac.github.io/firebirdre/yasup.png', effect:'petals'},
    bhuddhap:{src:'https://winaiac.github.io/firebirdre/bhuddhap.png', effect:'glow'},
    talep:{src:'https://winaiac.github.io/firebirdre/talep.png', effect:'water'},
    prasatp:{src:'https://winaiac.github.io/firebirdre/prasatp.png', effect:'bubbles'}
  };
  function resizeCanvas(){ effectCanvas.width=window.innerWidth; effectCanvas.height=window.innerHeight; }
  window.addEventListener('resize', resizeCanvas); resizeCanvas();
  function clearCanvas(){ ctx.clearRect(0,0,effectCanvas.width,effectCanvas.height); }

  // --- Effects Definitions (Stars, Petals, Bubbles, Ripples, Glow) ---
  // (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤ ‡∏ú‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏ö‡πÑ‡∏°‡πà‡∏•‡∏ö)

  // --- Effect Map & Background Switch ---
  const effectMap = {
    stars:{init:()=>{}, draw:()=>{}},
    petals:{init:()=>{}, draw:()=>{}},
    bubbles:{init:()=>{}, draw:()=>{}},
    water:{init:()=>{}, draw:()=>{}},
    glow:{init:()=>{}, draw:()=>{}},
    wind:{init:()=>{}, draw:()=>{}}
  };
  function updateBackground(bgKey){ /* ... ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }

  function animateLoop(){ if(activeEffect) activeEffect(); animationFrameId=requestAnimationFrame(animateLoop); }

  // --- UI Functions ---
  function updateUI(){
    userSection.classList.toggle('hidden', state.isLoggedIn);
    userInfo.classList.toggle('hidden', !state.isLoggedIn);
    usernameDisplay.textContent = state.user.worldId || state.user.userId;
    wldBalanceEl.textContent = state.user.wldBalance.toFixed(2);
    susanPointsEl.textContent = state.user.susanPoints;
    memorialText.value = state.user.memorial;
    transactionListEl.innerHTML = state.user.transactions.map(tx=>`<div>${tx.desc}: ${tx.amount.toFixed(2)}</div>`).join('');
  }
  function addTransaction(desc, amount){ state.user.transactions.unshift({desc,amount,date:new Date().toISOString()}); if(state.user.transactions.length>20) state.user.transactions.pop(); }

  async function handleLogin(worldIdProof=null){
    try{
      let userCredential = auth.currentUser ? {user:auth.currentUser} : await auth.signInAnonymously();
      const userId = userCredential.user.uid;
      state.isLoggedIn = true;
      state.user.userId = userId;
      state.user.worldId = worldIdProof ? worldIdProof.nullifier_hash.slice(0,12) : "@winai.9407";
      const loadedData = await loadData(userId);
      if(loadedData){ loadedData.transactions = loadedData.transactions||[]; state.user={...state.user,...loadedData}; }
      updateUI();
    }catch(e){ console.error(e); }
  }

  async function handleLogout(){
    await saveData(state.user.userId, state.user);
    await auth.signOut();
    state.isLoggedIn=false;
    state.user={ userId:null, worldId:null, susanPoints:500, wldBalance:10, transactions:[], memorial:"" };
    updateUI();
  }

  // --- Event Listeners ---
  window.addEventListener('click',()=>{ controlPanel.classList.add('visible'); clearTimeout(controlPanelTimeout); controlPanelTimeout=setTimeout(()=>{controlPanel.classList.remove('visible');},10000);});
  skipButton.addEventListener('click',()=>{ videoContainer.style.display='none'; mainAppContainer.style.display='block'; updateBackground('eyepp'); });

  logoutBtn.addEventListener('click',handleLogout);

  // --- World ID Setup ---
  function setupWorldIDButton(){
    let attempts=0;
    const maxAttempts=50;
    const interval=setInterval(()=>{
      if(typeof IDKit!=='undefined'){
        clearInterval(interval);
        loginBtn.disabled=false;
        loginBtn.textContent='‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö World ID';
        loginBtn.addEventListener('click',()=>{
          IDKit.open({
            app_id:"app_57493e6e2fb2153a6a50c98e358b4785",
            action:"logih",
            onSuccess:(proof)=>{ handleLogin(proof); },
            onError:(error)=>{ console.error(error); alert("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
          });
        });
      }else{
        attempts++;
        if(attempts>maxAttempts){ clearInterval(interval); loginBtn.textContent='World ID ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'; }
      }
    },100);
  }
  setupWorldIDButton();

  // --- Initial Load ---
  updateUI();
};
</script>

</body>
</html>
