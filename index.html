<!-- HTML Part -->
<div id="videoContainer">
  <video src="https://winaiac.github.io/firebirdre/yasu.mp4" autoplay muted></video>
  <button id="skipButton">ข้าม</button>
</div>

<div id="mainAppContainer" style="display:none;">
  <div id="controlPanel"></div>
  <div id="userSection">
    <button id="loginBtn" disabled>กำลังโหลด...</button>
    <button id="logoutBtn">ออกจากระบบ</button>
  </div>
  <div id="userInfo">
    <span id="usernameDisplay"></span>
    <span id="wldBalanceEl"></span>
    <span id="susanPointsEl"></span>
  </div>
  <input id="memorialText" type="text">
  <button id="saveMemorialBtn">บันทึกข้อความ</button>

  <button id="inviteBtn">เชิญเพื่อน</button>
  <button id="portfolioBtnNav">Portfolio</button>
  <button id="exchangeBtn">แลก WLD</button>
  <input id="wldAmountInput" type="number">
  
  <button id="activityBtnNav">กิจกรรมปลูกป่า</button>
  <div id="activityModal" style="display:none;">
    <input id="waterAmountInput" type="number">
    <button id="startActivityBtn">เริ่มกิจกรรม</button>
    <button id="endActivityBtn">จบกิจกรรม</button>
    <div id="activityTimerEl"></div>
    <div id="activityRewardEl"></div>
  </div>

  <button id="buyFlowerButton">ซื้อดอกไม้</button>
  <div id="flowerModal" style="display:none;">
    <button id="closeFlowerModalBtn">ปิด</button>
  </div>

  <div id="backgroundButtonsContainer">
    <button data-bg="eyepp">Eye</button>
    <button data-bg="pandorap">Pandora</button>
    <button data-bg="yasup">Yasup</button>
    <button data-bg="bhuddhap">Buddha</button>
    <button data-bg="talep">Talep</button>
    <button data-bg="prasatp">Prasat</button>
  </div>

  <button id="soundToggleBtn">เปิด/ปิดเสียง</button>
  <input id="volumeSlider" type="range" min="0" max="1" step="0.01">
</div>

<canvas id="effectCanvas"></canvas>

<script>
// --- State Management ---
let state = {
    isLoggedIn: false,
    isLightOn: false,
    isAdmin: false,
    user: { userId: null, worldId: null, susanPoints: 500, wldBalance: 10, transactions: [], memorial: "" },
    activity: { isActive: false, startTime: null, pointsCommitted: 0 },
    sound: { isPlaying: false, volume: 0.5 }
};

// --- Firebase Functions ---
async function saveData(userId, data) {
    if (!userId) return;
    try { await db.collection('users').doc(userId).set(data, { merge: true }); }
    catch (error) { console.error("Error saving data to Firebase:", error); }
}

async function loadData(userId) {
    if (!userId) return null;
    try {
        const doc = await db.collection('users').doc(userId).get();
        if (doc.exists) return doc.data();
        const defaultData = { susanPoints: 500, wldBalance: 10, transactions: [], memorial: "" };
        await saveData(userId, defaultData);
        return defaultData;
    } catch(e){ console.error(e); return null; }
}

// --- UI & App Flow ---
function updateUI() {
    userSection.classList.toggle('hidden', state.isLoggedIn);
    userInfo.classList.toggle('hidden', !state.isLoggedIn);
    usernameDisplay.textContent = state.user.worldId || state.user.userId || "";
    wldBalanceEl.textContent = state.user.wldBalance.toFixed(2);
    susanPointsEl.textContent = state.user.susanPoints;
    memorialText.value = state.user.memorial;
}

function addTransaction(desc, amount) {
    state.user.transactions.unshift({ desc, amount, date: new Date().toISOString() });
    if (state.user.transactions.length > 20) state.user.transactions.pop();
}

// --- World ID Integration ---
function setupWorldIDButton() {
    let attempts = 0;
    const interval = setInterval(() => {
        if (typeof IDKit !== 'undefined') {
            clearInterval(interval);
            loginBtn.disabled = false;
            loginBtn.textContent = 'เข้าสู่ระบบ World ID';
            loginBtn.addEventListener('click', () => {
                IDKit.open({
                    app_id: "app_57493e6e2fb2153a6a50c98e358b4785",
                    action: "logih",
                    onSuccess: proof => handleLogin(proof),
                    onError: err => { console.error(err); alert("เกิดข้อผิดพลาด World ID"); }
                });
            });
        } else { attempts++; if (attempts>50){ clearInterval(interval); loginBtn.textContent='World ID ล้มเหลว'; } }
    },100);
}

async function handleLogin(worldIdProof=null) {
    try {
        const userCredential = auth.currentUser ? {user:auth.currentUser} : await auth.signInAnonymously();
        const userId = userCredential.user.uid;
        state.isLoggedIn = true;
        state.user.userId = userId;
        state.user.worldId = worldIdProof ? worldIdProof.nullifier_hash.slice(0,12) : "@winai.9407";
        const loadedData = await loadData(userId);
        if(loadedData){ loadedData.transactions=loadedData.transactions||[]; state.user={...state.user,...loadedData}; }
        updateUI();
    } catch(e){ console.error(e); }
}

async function handleLogout() {
    await saveData(state.user.userId, state.user);
    await auth.signOut();
    state.isLoggedIn=false;
    state.user={ userId:null, worldId:null, susanPoints:500, wldBalance:10, transactions:[], memorial:"" };
    updateUI();
}

// --- Event Listeners ---
skipButton.addEventListener('click', ()=>{videoContainer.style.display='none'; mainAppContainer.style.display='block';});
window.addEventListener('click', ()=>{controlPanel.classList.add('visible'); setTimeout(()=>controlPanel.classList.remove('visible'),10000);});
window.addEventListener('mousemove', ()=>{controlPanel.classList.add('visible'); setTimeout(()=>controlPanel.classList.remove('visible'),10000);});

logoutBtn.addEventListener('click', handleLogout);
setupWorldIDButton();

// --- Invite Button ---
inviteBtn.addEventListener('click', ()=>{
    if(!state.user.worldId) return;
    const inviteLink=`https://winaiac.github.io/firebirdre/?ref=${state.user.worldId}`;
    navigator.clipboard.writeText(`เข้าร่วม SusanAI Online: ${inviteLink}`);
    alert('คัดลอกลิงก์เชิญแล้ว!');
});

// --- Exchange ---
exchangeBtn.addEventListener('click', ()=>{
    const wldAmount=parseFloat(document.getElementById('wldAmountInput').value);
    if(isNaN(wldAmount)||wldAmount<=0||wldAmount>state.user.wldBalance){ alert('จำนวน WLD ไม่ถูกต้อง'); return; }
    const pointsToAdd=wldAmount*50;
    state.user.wldBalance-=wldAmount;
    state.user.susanPoints+=pointsToAdd;
    addTransaction(`Exchange ${wldAmount} WLD`, pointsToAdd);
    updateUI();
    saveData(state.user.userId,{wldBalance:state.user.wldBalance,susanPoints:state.user.susanPoints,transactions:state.user.transactions});
});

// --- Memorial ---
saveMemorialBtn.addEventListener('click', ()=>{
    state.user.memorial=memorialText.value;
    saveData(state.user.userId,{memorial:state.user.memorial});
    alert('บันทึกข้อความแล้ว');
});

// --- Activity ---
startActivityBtn.addEventListener('click', ()=>{
    const amount=parseInt(document.getElementById('waterAmountInput').value);
    if(isNaN(amount)||amount<=0||amount>state.user.susanPoints){ alert('คะแนนไม่ถูกต้อง'); return; }
    state.user.susanPoints-=amount;
    state.activity={isActive:true,startTime:Date.now(),pointsCommitted:amount};
    addTransaction('เข้าร่วมกิจกรรมปลูกป่า',-amount);
    updateUI();
    saveData(state.user.userId,{susanPoints:state.user.susanPoints,transactions:state.user.transactions});
    activityStartDiv.classList.add('hidden');
    activityProgressDiv.classList.remove('hidden');
    activityPointsEl.textContent=amount;
    activityInterval=setInterval(updateActivity,1000);
});

endActivityBtn.addEventListener('click', ()=>{
    clearInterval(activityInterval);
    const elapsed=Math.floor((Date.now()-state.activity.startTime)/1000);
    const totalRewardPool=60000000,totalWater=12000000;
    const userShare=state.activity.pointsCommitted/totalWater;
    const rewardPerSecond=totalRewardPool/(24*3600);
    const finalReward=userShare*rewardPerSecond*elapsed;
    state.user.susanPoints+=finalReward;
    addTransaction('รับรางวัลกิจกรรม',finalReward);
    alert(`กิจกรรมสิ้นสุด! คุณได้รับ ${finalReward.toFixed(2)} คะแนน`);
    state.activity={isActive:false,startTime:null,pointsCommitted:0};
    activityStartDiv.classList.remove('hidden');
    activityProgressDiv.classList.add('hidden');
    updateUI();
    saveData(state.user.userId,{susanPoints:state.user.susanPoints,transactions:state.user.transactions});
});

// --- Flowers ---
buyFlowerButton.addEventListener('click', ()=>{
    if(state.user.susanPoints>=10){
        state.user.susanPoints-=10;
        addTransaction('ซื้อดอกไม้',-10);
        updateUI();
        saveData(state.user.userId,{susanPoints:state.user.susanPoints,transactions:state.user.transactions});
        flowerModal.style.display='flex';
    }else alert('คะแนน Susan ไม่เพียงพอ!');
});
closeFlowerModalBtn.addEventListener('click',()=>{flowerModal.style.display='none';});

// --- Background Buttons ---
backgroundButtonsContainer.addEventListener('click',(e)=>{
    if(e.target.tagName==='BUTTON'){
        const bgKey=e.target.dataset.bg;
        if(bgKey) updateBackground(bgKey);
    }
});

// --- Sound Controls ---
soundToggleBtn.addEventListener('click', ()=>{
    state.sound.isPlaying=!state.sound.isPlaying;
    if(state.sound.isPlaying){ backgroundAudio.play(); soundOnIcon.classList.remove('hidden'); soundOffIcon.classList.add('hidden'); }
    else{ backgroundAudio.pause(); soundOnIcon.classList.add('hidden'); soundOffIcon.classList.remove('hidden'); }
});
volumeSlider.addEventListener('input',(e)=>{ state.sound.volume=e.target.value; backgroundAudio.volume=state.sound.volume; });

// --- Initial UI Update ---
updateUI();

</script>
