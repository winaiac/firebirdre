<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://unpkg.com https://verify.worldcoin.org;
        connect-src 'self' wss://*.firebaseio.com https://susanonline-9ccbb.firebaseio.com https://www.googleapis.com https://firebaseauth.googleapis.com https://verify.worldcoin.org;
        frame-src 'self' https://susanonline-9ccbb.firebaseapp.com https://verify.worldcoin.org;
        img-src 'self' data: https://*;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        media-src 'self' https://*;
    ">
    <title>SusanAI Online - Full Stack Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Worldcoin IDKit SDK (Standalone Version for Vanilla JS) -->
    <script src="https://unpkg.com/@worldcoin/idkit-standalone@1/dist/idkit.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body { font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; }
        .background-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .background-image { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 1; opacity: 1; transition: opacity 1s ease-in-out; }
        .background-container::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); z-index: 1; }
        .background-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        .glass-menu { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.2); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .video-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; background-color: black; z-index: 1000; }
        .video-container video { min-width: 100%; min-height: 100%; width: auto; height: auto; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); object-fit: cover; }
        .main-app-container { display: none; width: 100vw; height: 100vh; overflow-y: auto; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-box { background-color: rgba(20, 20, 30, 0.9); color: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); max-width: 90%; border: 1px solid rgba(255, 255, 255, 0.2); }
        .control-panel { position: fixed; bottom: -120px; left: 50%; transform: translateX(-50%); z-index: 20; display: flex; flex-direction: column; align-items: center; gap: 1rem; transition: bottom 0.5s ease-in-out; }
        .control-panel.visible { bottom: 1rem; }
        .control-buttons-container { display: flex; gap: 1rem; background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); padding: 0.75rem 1.5rem; border-radius: 9999px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .control-buttons-container button { background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        #light-bulb { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, rgba(255, 255, 220, 0.25), transparent 60%); opacity: 0; transition: opacity 0.5s ease; pointer-events: none; z-index: 5; }
        #light-bulb.on { opacity: 1; }
        
        .collapsible-panel { position: fixed; top: 80px; right: -400px; width: 400px; height: calc(100vh - 100px); background-color: rgba(10, 10, 20, 0.8); backdrop-filter: blur(10px); border-left: 1px solid rgba(255,255,255,0.2); transition: right 0.5s ease; z-index: 100; display: flex; flex-direction: column; border-radius: 15px 0 0 15px; }
        .collapsible-panel.open { right: 0; }
        .panel-toggle-button { position: absolute; top: 50%; left: -30px; transform: translateY(-50%); width: 30px; height: 100px; background-color: rgba(10, 10, 20, 0.8); border-radius: 10px 0 0 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; border-left: 1px solid rgba(255,255,255,0.2); border-top: 1px solid rgba(255,255,255,0.2); border-bottom: 1px solid rgba(255,255,255,0.2); }
        .sound-console { position: fixed; bottom: 1rem; left: 1rem; z-index: 25; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); padding: 0.5rem 1rem; border-radius: 9999px; display: flex; align-items: center; gap: 0.75rem; }

        /* --- NEW STYLES for Admin & Prize Pool --- */
        #prizePoolDisplay {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #f0c435, #ff8c00);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
            z-index: 15;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4); }
            50% { transform: translateX(-50%) scale(1.05); box-shadow: 0 6px 20px rgba(255, 165, 0, 0.6); }
            100% { transform: translateX(-50%) scale(1); box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4); }
        }

        .admin-input {
            background-color: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px;
            width: 100%;
            margin-top: 4px;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">

    <div id="videoContainer" class="video-container">
        <video id="introVideo" autoplay muted playsinline>
            <source src="https://winaiac.github.io/firebirdre/eyep.mp4" type="video/mp4">
            <source src="https://winaiac.github.io/firebirdre/yasu.mp4" type="video/mp4">
            <source src="https://winaiac.github.io/firebirdre/pandora.mp4" type="video/mp4">
            เบราว์เซอร์ของคุณไม่รองรับการเล่นวิดีโอ
        </video>
        <button id="skipButton" class="absolute bottom-5 right-5 z-[1001] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105">ข้ามเข้าแอป</button>
    </div>

    <div id="mainAppContainer" class="main-app-container">
        <div id="light-bulb"></div>
        <div class="background-container">
            <img id="bgImage" class="background-image" src="https://winaiac.github.io/firebirdre/eyepp.png">
            <canvas id="effectCanvas" class="background-canvas"></canvas>
        </div>

        <nav class="glass-menu fixed top-0 left-0 w-full z-20 p-4 flex justify-between items-center px-8">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-white">SusanAI</h1>
                <div id="main-nav-links" class="flex items-center space-x-2 md:space-x-4">
                    <a href="#" id="homeLink" class="text-white hover:text-yellow-400">หน้าหลัก</a>
                    <a href="#" id="portfolioBtnNav" class="text-white hover:text-yellow-400 hidden member-only">Portfolio</a>
                    <a href="#" id="activityBtnNav" class="text-white hover:text-yellow-400 hidden member-only">กิจกรรม</a>
                    <a href="#" id="ebookBtnNav" class="text-white hover:text-yellow-400 hidden member-only">E-Book</a>
                    <!-- NEW: Admin Panel Button -->
                    <a href="#" id="adminPanelBtn" class="text-yellow-300 hover:text-yellow-500 hidden">แผงควบคุมแอดมิน</a>
                </div>
            </div>
            <div id="user-section" class="flex items-center gap-4">
                 <button id="googleLoginBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition">เข้าสู่ระบบด้วย Google</button>
                 <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition">เข้าสู่ระบบ World ID (จำลอง)</button>
            </div>
            <div id="user-info" class="hidden items-center gap-4">
                <span id="username-display" class="text-white font-semibold"></span>
                <button id="inviteBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full transition">เชิญเพื่อน</button>
                <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition">ออกจากระบบ</button>
            </div>
        </nav>
        
        <!-- NEW: Prize Pool Display -->
        <div id="prizePoolDisplay" class="hidden member-only">
            ธนาคารกลาง: <span id="prizePoolAmount">0</span> คะแนน
        </div>

        <main id="content-area" class="relative w-full h-full">
            <section id="home-content" class="w-full h-full flex flex-col items-center justify-center text-center p-8 opacity-0 transition-opacity duration-1000">
                 <div class="bg-black/40 p-8 rounded-2xl shadow-xl max-w-2xl w-full">
                    <h2 class="text-3xl font-bold mb-4 text-white">ยินดีต้อนรับสู่ SusanAI</h2>
                 </div>
            </section>
        </main>
        
        <div id="controlPanel" class="control-panel">
            <div class="control-buttons-container">
                <button id="toggleLightButton" class="text-white font-bold py-3 px-5 rounded-full shadow-lg transition transform hover:scale-110">เปิดไฟ</button>
                <button id="buyFlowerButton" class="text-white font-bold py-3 px-5 rounded-full shadow-lg transition transform hover:scale-110">ซื้อดอกไม้</button>
            </div>
            <div id="backgroundButtons" class="control-buttons-container">
                <button data-bg="eyepp" class="text-white px-4 py-2 rounded-full transition">Pyramid</button>
                <button data-bg="pandorap" class="text-white px-4 py-2 rounded-full transition">Pandora</button>
                <button data-bg="yasup" class="text-white px-4 py-2 rounded-full transition">Sakura</button>
                <button data-bg="bhuddhap" class="text-white px-4 py-2 rounded-full transition hidden member-only">Buddha</button>
                <button data-bg="talep" class="text-white px-4 py-2 rounded-full transition hidden member-only">Sea</button>
                <button data-bg="prasatp" class="text-white px-4 py-2 rounded-full transition hidden member-only">Castle</button>
            </div>
        </div>

        <div id="portfolioPanel" class="collapsible-panel member-only hidden">
            <div class="panel-toggle-button" onclick="document.getElementById('portfolioPanel').classList.toggle('open')">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </div>
            <div class="p-4 text-white overflow-y-auto">
                <h3 class="text-2xl font-bold text-center mb-4">Portfolio</h3>
                <div class="bg-white/10 p-4 rounded-lg mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-lg">WLD Balance:</span>
                        <span id="wldBalance" class="text-xl font-bold">10.00</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-lg">Susan Points:</span>
                        <span id="susanPoints" class="text-xl font-bold text-yellow-400">500</span>
                    </div>
                    <div class="mt-4">
                        <input type="number" id="wldAmountInput" class="w-full bg-black/50 p-2 rounded" placeholder="จำนวน WLD ที่จะแลก">
                        <button id="exchangeBtn" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 p-2 rounded">แลกเป็น Susan Points (1:50)</button>
                    </div>
                </div>
                <h4 class="text-xl font-bold mt-6 mb-2">ประวัติธุรกรรม</h4>
                <div id="transactionList" class="space-y-2 max-h-40 overflow-y-auto"></div>
                <h4 class="text-xl font-bold mt-6 mb-2">บันทึกถึงผู้ล่วงลับ</h4>
                <textarea id="memorialText" class="w-full h-32 bg-black/50 p-2 rounded" placeholder="เขียนข้อความของคุณที่นี่..."></textarea>
                <button id="saveMemorialBtn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 p-2 rounded">บันทึก</button>
            </div>
        </div>

        <div class="sound-console">
            <button id="soundToggleBtn">
                <svg class="w-6 h-6 text-white" id="sound-on-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                <svg class="w-6 h-6 text-white hidden" id="sound-off-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>
            </button>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" class="w-24">
        </div>
        <audio id="backgroundAudio" loop src="https://winaiac.github.io/firebirdre/Dream_It_Possible.mp3"></audio>

        <!-- Modals for features -->
        <div id="activityModal" class="modal-overlay">
            <div class="modal-box w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">กิจกรรมปลูกป่า</h2>
                <div id="activity-start">
                    <p class="mb-4">ใช้คะแนน Susan เพื่อ "รดน้ำ" ต้นไม้และรับรางวัลตามสัดส่วนและเวลาที่อยู่ในกิจกรรม</p>
                    <input type="number" id="waterAmountInput" class="w-full bg-black/50 p-2 rounded text-white" placeholder="คะแนน Susan ที่จะใช้ (ค่าน้ำ)">
                    <button id="startActivityBtn" class="w-full mt-2 bg-green-600 hover:bg-green-700 p-2 rounded">เริ่มรดน้ำ</button>
                </div>
                <div id="activity-progress" class="hidden">
                    <p>กำลังรดน้ำ... เวลาผ่านไป: <span id="activityTimer">00:00:00</span></p>
                    <p>คะแนนที่ใช้: <span id="activityPoints" class="font-bold text-yellow-400"></span></p>
                    <p>รางวัลที่คาดว่าจะได้รับ: <span id="activityReward" class="font-bold text-green-400"></span></p>
                    <button id="endActivityBtn" class="w-full mt-4 bg-red-600 hover:bg-red-700 p-2 rounded">สิ้นสุดและรับรางวัล</button>
                </div>
            </div>
        </div>
        
        <div id="flowerModal" class="modal-overlay">
            <div class="modal-box">
                <h2 class="text-2xl font-bold mb-4">ขอบคุณสำหรับการซื้อดอกไม้!</h2>
                <p id="flowerPriceText" class="mb-6"></p>
                <button id="closeFlowerModalBtn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 p-2 rounded">ตกลง</button>
            </div>
        </div>
        
        <!-- NEW: Admin Panel Modal -->
        <div id="adminModal" class="modal-overlay">
            <div class="modal-box w-full max-w-lg text-left">
                <h2 class="text-2xl font-bold mb-6 text-center">แผงควบคุมแอดมิน</h2>
                <!-- Game Settings -->
                <div class="space-y-4">
                    <div>
                        <label for="prizePoolInput">ตั้งค่าธนาคารกลาง (คะแนน)</label>
                        <input type="number" id="prizePoolInput" class="admin-input">
                    </div>
                    <div>
                        <label for="flowerPriceInput">ตั้งราคาดอกไม้ (คะแนน)</label>
                        <input type="number" id="flowerPriceInput" class="admin-input">
                    </div>
                    <button id="saveSettingsBtn" class="w-full mt-2 bg-green-600 hover:bg-green-700 p-2 rounded">บันทึกการตั้งค่า</button>
                </div>
                <hr class="my-6 border-gray-600">
                <!-- Add Credits -->
                <div class="space-y-4">
                     <h3 class="text-xl font-bold">เติมเครดิตให้ผู้ใช้</h3>
                    <div>
                        <label for="creditUserIdInput">User ID</label>
                        <input type="text" id="creditUserIdInput" class="admin-input" placeholder="ใส่ User ID ของผู้ใช้">
                    </div>
                    <div>
                        <label for="creditAmountInput">จำนวนคะแนน</label>
                        <input type="number" id="creditAmountInput" class="admin-input" placeholder="ใส่จำนวนคะแนนที่ต้องการเพิ่ม">
                    </div>
                    <button id="addCreditBtn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 p-2 rounded">เติมเครดิต</button>
                </div>
                <button id="closeAdminModalBtn" class="w-full mt-8 bg-gray-700 hover:bg-gray-800 p-2 rounded">ปิด</button>
            </div>
        </div>

    </div>

    <script>
    // Changed from DOMContentLoaded to window.onload to ensure all scripts are loaded
    window.onload = () => {
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyConQt3RWBYU3XGyTWvhU6O5SKk3mTgCHo",
            authDomain: "susanonline-9ccbb.firebaseapp.com",
            projectId: "susanonline-9ccbb",
            storageBucket: "susanonline-9ccbb.appspot.com",
            messagingSenderId: "186979315282",
            appId: "1:186979315282:web:3d0fef4f79d6954ca2f98b",
            measurementId: "G-8EF06Q3DNH"
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Elements ---
        const videoContainer = document.getElementById('videoContainer');
        const skipButton = document.getElementById('skipButton');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const bgImage = document.getElementById('bgImage');
        const effectCanvas = document.getElementById('effectCanvas');
        const homeContent = document.getElementById('home-content');
        const controlPanel = document.getElementById('controlPanel');
        const toggleLightButton = document.getElementById('toggleLightButton');
        const lightBulb = document.getElementById('light-bulb');
        const backgroundButtonsContainer = document.getElementById('backgroundButtons');
        const loginBtn = document.getElementById('loginBtn');
        const googleLoginBtn = document.getElementById('googleLoginBtn'); 
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userSection = document.getElementById('user-section');
        const userInfo = document.getElementById('user-info');
        const usernameDisplay = document.getElementById('username-display');
        const inviteBtn = document.getElementById('inviteBtn');
        const portfolioPanel = document.getElementById('portfolioPanel');
        const wldBalanceEl = document.getElementById('wldBalance');
        const susanPointsEl = document.getElementById('susanPoints');
        const exchangeBtn = document.getElementById('exchangeBtn');
        const transactionListEl = document.getElementById('transactionList');
        const memorialText = document.getElementById('memorialText');
        const saveMemorialBtn = document.getElementById('saveMemorialBtn');
        const portfolioBtnNav = document.getElementById('portfolioBtnNav');
        const activityBtnNav = document.getElementById('activityBtnNav');
        const ebookBtnNav = document.getElementById('ebookBtnNav');
        const activityModal = document.getElementById('activityModal');
        const startActivityBtn = document.getElementById('startActivityBtn');
        const endActivityBtn = document.getElementById('endActivityBtn');
        const activityStartDiv = document.getElementById('activity-start');
        const activityProgressDiv = document.getElementById('activity-progress');
        const activityTimerEl = document.getElementById('activityTimer');
        const activityPointsEl = document.getElementById('activityPoints');
        const activityRewardEl = document.getElementById('activityReward');
        const soundToggleBtn = document.getElementById('soundToggleBtn');
        const soundOnIcon = document.getElementById('sound-on-icon');
        const soundOffIcon = document.getElementById('sound-off-icon');
        const volumeSlider = document.getElementById('volumeSlider');
        const backgroundAudio = document.getElementById('backgroundAudio');
        const homeLink = document.getElementById('homeLink');
        const buyFlowerButton = document.getElementById('buyFlowerButton');
        const flowerModal = document.getElementById('flowerModal');
        const closeFlowerModalBtn = document.getElementById('closeFlowerModalBtn');
        const flowerPriceText = document.getElementById('flowerPriceText');
        const prizePoolDisplay = document.getElementById('prizePoolDisplay');
        const prizePoolAmountEl = document.getElementById('prizePoolAmount');
        
        // Admin Elements
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const adminModal = document.getElementById('adminModal');
        const closeAdminModalBtn = document.getElementById('closeAdminModalBtn');
        const prizePoolInput = document.getElementById('prizePoolInput');
        const flowerPriceInput = document.getElementById('flowerPriceInput');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const creditUserIdInput = document.getElementById('creditUserIdInput');
        const creditAmountInput = document.getElementById('creditAmountInput');
        const addCreditBtn = document.getElementById('addCreditBtn');


        const ctx = effectCanvas.getContext('2d');
        let animationFrameId = null, activeEffect = null, controlPanelTimeout, activityInterval;

        // --- State Management ---
        let state = {
            isLoggedIn: false,
            isLightOn: false,
            isAdmin: false,
            user: { userId: null, worldId: null, displayName: null, susanPoints: 500, wldBalance: 10, transactions: [], memorial: "" },
            activity: { isActive: false, startTime: null, pointsCommitted: 0 },
            sound: { isPlaying: false, volume: 0.5 },
            gameSettings: { prizePool: 60000000, flowerPrice: 10 }
        };

        // --- Firebase Functions ---
        async function saveData(collection, docId, data) {
            if (!docId) return;
            console.log(`Saving to Firebase/${collection}/${docId}`, data);
            try {
                await db.collection(collection).doc(docId).set(data, { merge: true });
            } catch (error) {
                console.error("Error saving data to Firebase: ", error);
            }
        }

        async function loadData(collection, docId) {
            if (!docId) return null;
            console.log(`Loading from Firebase/${collection}/${docId}`);
            try {
                const docRef = db.collection(collection).doc(docId);
                const doc = await docRef.get();
                if (doc.exists) {
                    return doc.data();
                }
                return null;
            } catch (error) {
                console.error("Error loading data from Firebase: ", error);
                return null;
            }
        }

        const backgroundData = {
            eyepp: { src: 'https://winaiac.github.io/firebirdre/eyepp.png', effect: 'wind' },
            pandorap: { src: 'https://winaiac.github.io/firebirdre/pandorap.png', effect: 'stars' },
            yasup: { src: 'https://winaiac.github.io/firebirdre/yasup.png', effect: 'petals' },
            bhuddhap: { src: 'https://winaiac.github.io/firebirdre/bhuddhap.png', effect: 'glow' },
            talep: { src: 'https://winaiac.github.io/firebirdre/talep.png', effect: 'water' },
            prasatp: { src: 'https://winaiac.github.io/firebirdre/prasatp.png', effect: 'bubbles' }
        };
        
        // --- Canvas & Effects Logic (No changes) ---
        function resizeCanvas() { effectCanvas.width = window.innerWidth; effectCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();
        function clearCanvas() { ctx.clearRect(0, 0, effectCanvas.width, effectCanvas.height); }
        let stars = [], petals = [], bubbles = [], ripples = []; let glowAnimation = { radius: 150, opacity: 0, direction: 1 };
        function initStars() { stars = Array.from({ length: 300 }, () => ({ x: Math.random() * effectCanvas.width, y: Math.random() * effectCanvas.height, radius: Math.random() * 1.5, opacity: Math.random() * 0.5 + 0.1, velocity: Math.random() * 0.02 + 0.01 })); }
        function drawStars() { clearCanvas(); stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2); ctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`; ctx.fill(); s.opacity += s.velocity; if (s.opacity > 0.8 || s.opacity < 0.1) s.velocity *= -1; }); }
        function initPetals() { petals = Array.from({ length: 50 }, () => ({ x: Math.random() * effectCanvas.width, y: Math.random() * effectCanvas.height, size: Math.random() * 10 + 5, opacity: Math.random() * 0.7 + 0.3, rotation: Math.random() * 360, rSpeed: Math.random() * 0.02 - 0.01, xVel: Math.random() * 0.5 - 0.25, yVel: Math.random() * 1.5 + 0.5 })); }
        function drawPetals() { clearCanvas(); petals.forEach(p => { ctx.beginPath(); ctx.fillStyle = `rgba(255, 182, 193, ${p.opacity})`; ctx.ellipse(p.x, p.y, p.size / 2, p.size, p.rotation, 0, Math.PI * 2); ctx.fill(); p.x += p.xVel; p.y += p.yVel; p.rotation += p.rSpeed; if (p.y > effectCanvas.height) { p.x = Math.random() * effectCanvas.width; p.y = -20; } }); }
        function initBubbles() { bubbles = Array.from({ length: 40 }, () => ({ x: Math.random() * effectCanvas.width, y: effectCanvas.height + Math.random() * 100, radius: Math.random() * 15 + 5, speed: Math.random() * 1 + 0.5, opacity: Math.random() * 0.4 + 0.1 })); }
        function drawBubbles() { clearCanvas(); bubbles.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2); ctx.strokeStyle = `rgba(255, 255, 255, ${b.opacity})`; ctx.lineWidth = 2; ctx.stroke(); b.y -= b.speed; if (b.y < -b.radius) { b.y = effectCanvas.height + b.radius; b.x = Math.random() * effectCanvas.width; } }); }
        function initRipples() { ripples = Array.from({ length: 5 }, () => ({ x: Math.random() * effectCanvas.width, y: Math.random() * effectCanvas.height, radius: 0, maxRadius: Math.random() * 100 + 50, speed: 0.5, opacity: 1 })); }
        function drawWater() { clearCanvas(); ripples.forEach(r => { ctx.beginPath(); ctx.arc(r.x, r.y, r.radius, 0, 2 * Math.PI); ctx.strokeStyle = `rgba(255, 255, 255, ${r.opacity})`; ctx.lineWidth = 2; ctx.stroke(); r.radius += r.speed; r.opacity = 1 - r.radius / r.maxRadius; if (r.opacity <= 0) { r.radius = 0; r.opacity = 1; r.x = Math.random() * effectCanvas.width; r.y = Math.random() * effectCanvas.height; } }); }
        function drawGlow() { clearCanvas(); const centerX = effectCanvas.width / 2; const centerY = effectCanvas.height / 2; const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 150); gradient.addColorStop(0, `rgba(255, 223, 100, ${glowAnimation.opacity * 0.7})`); gradient.addColorStop(0.8, `rgba(255, 223, 100, ${glowAnimation.opacity * 0.1})`); gradient.addColorStop(1, 'rgba(255, 223, 100, 0)'); ctx.fillStyle = gradient; ctx.fillRect(0, 0, effectCanvas.width, effectCanvas.height); glowAnimation.opacity += 0.005 * glowAnimation.direction; if (glowAnimation.opacity > 0.5 || glowAnimation.opacity < 0) glowAnimation.direction *= -1; }
        const effectMap = { stars: { init: initStars, draw: drawStars }, petals: { init: initPetals, draw: drawPetals }, bubbles: { init: initBubbles, draw: drawBubbles }, water: { init: initRipples, draw: drawWater }, glow: { init: () => {}, draw: drawGlow }, wind: { init: () => {}, draw: () => {} }, };
        
        function updateBackground(bgKey) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            clearCanvas();
            document.querySelectorAll('.wind-effect-overlay').forEach(el => el.remove());
            const data = backgroundData[bgKey];
            if (!data) return;
            document.body.style.cursor = 'wait';
            bgImage.style.opacity = 0;
            setTimeout(() => {
                const img = new Image();
                img.src = data.src;
                img.onload = () => {
                    document.body.style.cursor = 'default';
                    bgImage.src = data.src;
                    bgImage.style.opacity = 1;
                    const effect = effectMap[data.effect];
                    if (effect) { effect.init(); activeEffect = effect.draw; if (bgKey === 'wind') { const windOverlay = document.createElement('div'); windOverlay.className = 'wind-effect-overlay'; document.querySelector('.background-container').appendChild(windOverlay); } } else { activeEffect = null; }
                    animateLoop();
                };
                img.onerror = () => { document.body.style.cursor = 'default'; alert(`เกิดข้อผิดพลาด: ไม่สามารถโหลดรูปภาพพื้นหลังสำหรับ '${bgKey}' ได้`); };
            }, 500);
        }

        function animateLoop() { if (activeEffect) activeEffect(); animationFrameId = requestAnimationFrame(animateLoop); }

        // --- UI & App Flow ---
        function showMainApp() { videoContainer.style.display = 'none'; mainAppContainer.style.display = 'block'; updateBackground('eyepp'); homeContent.style.opacity = '1'; showControlPanel(); }
        function showControlPanel() { controlPanel.classList.add('visible'); clearTimeout(controlPanelTimeout); controlPanelTimeout = setTimeout(() => { controlPanel.classList.remove('visible'); }, 10000); }

        function updateUI() {
            userSection.classList.toggle('hidden', state.isLoggedIn);
            userInfo.classList.toggle('hidden', !state.isLoggedIn);
            document.querySelectorAll('.member-only').forEach(el => el.classList.toggle('hidden', !state.isLoggedIn));
            adminPanelBtn.classList.toggle('hidden', !state.isAdmin);
            if (state.isLoggedIn) { 
                usernameDisplay.textContent = state.user.displayName || state.user.worldId || state.user.userId;
                prizePoolAmountEl.textContent = state.gameSettings.prizePool.toLocaleString();
            }
            wldBalanceEl.textContent = state.user.wldBalance.toFixed(2);
            susanPointsEl.textContent = state.user.susanPoints;
            memorialText.value = state.user.memorial;
            transactionListEl.innerHTML = state.user.transactions.map(tx => `<div class="text-sm ${tx.amount > 0 ? 'text-green-400' : 'text-red-400'}">${tx.desc}: ${tx.amount.toFixed(2)} Points</div>`).join('');
        }
        
        function addTransaction(desc, amount) {
            state.user.transactions.unshift({ desc, amount, date: new Date().toISOString() });
            if (state.user.transactions.length > 20) state.user.transactions.pop();
        }

        async function handleLogin(loginResult = null) {
            try {
                const userId = loginResult.user.uid;
                state.isLoggedIn = true;
                state.user.userId = userId;
                
                // Check if admin
                if (loginResult.user.email === 'winayo@gmail.com') {
                    state.isAdmin = true;
                }
                
                // Check login type
                if (loginResult.providerData && loginResult.providerData[0].providerId === 'google.com') {
                    state.user.displayName = loginResult.user.displayName;
                    state.user.worldId = null; // Clear worldId if logging in with Google
                } else { // World ID or Anonymous
                    state.user.displayName = null;
                    state.user.worldId = "@winai.9407"; 
                }

                const loadedData = await loadData('users', userId);
                if (loadedData) {
                    loadedData.transactions = loadedData.transactions || [];
                    state.user = { ...state.user, ...loadedData };
                }
                updateUI();
            } catch (error) {
                console.error("Error during login:", error);
            }
        }

        async function handleLogout() {
            await saveData('users', state.user.userId, state.user);
            await auth.signOut();
            state.isLoggedIn = false;
            state.isAdmin = false;
            state.user = { userId: null, worldId: null, displayName: null, susanPoints: 500, wldBalance: 10, transactions: [], memorial: "" }; // Reset state
            updateUI();
        }

        // --- Event Listeners ---
        window.addEventListener('click', showControlPanel);
        window.addEventListener('mousemove', showControlPanel);
        skipButton.addEventListener('click', showMainApp);
        videoContainer.querySelector('video').addEventListener('ended', showMainApp);
        
        // --- UPDATED: World ID Login (Simulation) ---
        loginBtn.addEventListener('click', () => {
            alert("นี่คือการจำลองการเข้าสู่ระบบด้วย World ID");
            handleLogin({ user: { uid: 'simulated_world_id_user' } });
        });
        
        // --- NEW: Google Login ---
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                handleLogin({ user: result.user, providerData: result.user.providerData });
            } catch (error) {
                console.error("Google Login Error:", error);
                alert("เกิดข้อผิดพลาดในการล็อกอินด้วย Google");
            }
        });

        logoutBtn.addEventListener('click', handleLogout);

        inviteBtn.addEventListener('click', () => {
            const inviteLink = `https://susanonline-9ccbb.web.app/?ref=${state.user.userId}`;
            navigator.clipboard.writeText(`เข้าร่วม SusanAI Online และรับสิทธิพิเศษ! สนับสนุนโดยแอป Susan Online: ${inviteLink}`);
            alert('คัดลอกลิงก์เชิญแล้ว!');
        });
        
        portfolioBtnNav.addEventListener('click', (e) => { e.preventDefault(); portfolioPanel.classList.toggle('open'); });
        
        exchangeBtn.addEventListener('click', () => {
            const wldAmount = parseFloat(document.getElementById('wldAmountInput').value);
            if (isNaN(wldAmount) || wldAmount <= 0 || wldAmount > state.user.wldBalance) { alert('จำนวน WLD ไม่ถูกต้อง'); return; }
            const pointsToAdd = wldAmount * 50;
            state.user.wldBalance -= wldAmount;
            state.user.susanPoints += pointsToAdd;
            addTransaction(`Exchange ${wldAmount} WLD`, pointsToAdd);
            updateUI();
            saveData('users', state.user.userId, { wldBalance: state.user.wldBalance, susanPoints: state.user.susanPoints, transactions: state.user.transactions });
        });

        saveMemorialBtn.addEventListener('click', () => {
            state.user.memorial = memorialText.value;
            saveData('users', state.user.userId, { memorial: state.user.memorial });
            alert('บันทึกข้อความแล้ว');
        });

        activityBtnNav.addEventListener('click', (e) => { e.preventDefault(); activityModal.style.display = 'flex'; });
        activityModal.addEventListener('click', (e) => { if(e.target === activityModal) activityModal.style.display = 'none'; });

        startActivityBtn.addEventListener('click', () => {
            const amount = parseInt(document.getElementById('waterAmountInput').value);
            if (isNaN(amount) || amount <= 0 || amount > state.user.susanPoints) { alert('คะแนนไม่ถูกต้อง'); return; }
            state.user.susanPoints -= amount;
            state.activity = { isActive: true, startTime: Date.now(), pointsCommitted: amount };
            addTransaction('เข้าร่วมกิจกรรมปลูกป่า', -amount);
            updateUI();
            saveData('users', state.user.userId, { susanPoints: state.user.susanPoints, transactions: state.user.transactions });
            activityStartDiv.classList.add('hidden');
            activityProgressDiv.classList.remove('hidden');
            activityPointsEl.textContent = amount;
            activityInterval = setInterval(updateActivity, 1000);
        });

        function updateActivity() {
            if (!state.activity.isActive) return;
            const elapsed = Math.floor((Date.now() - state.activity.startTime) / 1000);
            const hours = Math.floor(elapsed / 3600).toString().padStart(2,'0');
            const minutes = Math.floor((elapsed % 3600) / 60).toString().padStart(2,'0');
            const seconds = (elapsed % 60).toString().padStart(2,'0');
            activityTimerEl.textContent = `${hours}:${minutes}:${seconds}`;
            const totalRewardPool = state.gameSettings.prizePool;
            const totalWater = totalRewardPool / 5; // Example condition
            const userShare = state.activity.pointsCommitted / totalWater;
            const rewardPerSecond = totalRewardPool / (24 * 3600);
            const currentReward = userShare * rewardPerSecond * elapsed;
            activityRewardEl.textContent = currentReward.toFixed(2);
        }

        endActivityBtn.addEventListener('click', () => {
            clearInterval(activityInterval);
            const elapsed = Math.floor((Date.now() - state.activity.startTime) / 1000);
            const totalRewardPool = state.gameSettings.prizePool;
            const totalWater = totalRewardPool / 5;
            const userShare = state.activity.pointsCommitted / totalWater;
            const rewardPerSecond = totalRewardPool / (24 * 3600);
            const finalReward = userShare * rewardPerSecond * elapsed;
            state.user.susanPoints += finalReward;
            addTransaction('รับรางวัลกิจกรรม', finalReward);
            alert(`กิจกรรมสิ้นสุด! คุณได้รับ ${finalReward.toFixed(2)} คะแนน`);
            state.activity = { isActive: false, startTime: null, pointsCommitted: 0 };
            activityStartDiv.classList.remove('hidden');
            activityProgressDiv.classList.add('hidden');
            updateUI();
            saveData('users', state.user.userId, { susanPoints: state.user.susanPoints, transactions: state.user.transactions });
        });
        
        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            portfolioPanel.classList.remove('open');
            activityModal.style.display = 'none';
            flowerModal.style.display = 'none';
        });

        buyFlowerButton.addEventListener('click', () => {
            const price = state.gameSettings.flowerPrice;
            if (state.user.susanPoints >= price) {
                state.user.susanPoints -= price;
                addTransaction('ซื้อดอกไม้', -price);
                updateUI();
                saveData('users', state.user.userId, { susanPoints: state.user.susanPoints, transactions: state.user.transactions });
                flowerPriceText.textContent = `ดอกไม้จะคงอยู่ 7 วัน คะแนน Susan ของคุณถูกใช้ไป ${price} คะแนน`;
                flowerModal.style.display = 'flex';
            } else {
                alert('คะแนน Susan ไม่เพียงพอ!');
            }
        });
        
        closeFlowerModalBtn.addEventListener('click', () => {
            flowerModal.style.display = 'none';
        });
        
        backgroundButtonsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const bgKey = e.target.dataset.bg;
                if (bgKey) updateBackground(bgKey);
            }
        });

        // Sound Controls
        soundToggleBtn.addEventListener('click', () => {
            state.sound.isPlaying = !state.sound.isPlaying;
            if (state.sound.isPlaying) { backgroundAudio.play(); soundOnIcon.classList.remove('hidden'); soundOffIcon.classList.add('hidden'); } 
            else { backgroundAudio.pause(); soundOnIcon.classList.add('hidden'); soundOffIcon.classList.remove('hidden'); }
        });
        volumeSlider.addEventListener('input', (e) => { state.sound.volume = e.target.value; backgroundAudio.volume = state.sound.volume; });

        // --- Admin Panel Logic ---
        adminPanelBtn.addEventListener('click', (e) => {
            e.preventDefault();
            prizePoolInput.value = state.gameSettings.prizePool;
            flowerPriceInput.value = state.gameSettings.flowerPrice;
            adminModal.style.display = 'flex';
        });

        closeAdminModalBtn.addEventListener('click', () => {
            adminModal.style.display = 'none';
        });

        saveSettingsBtn.addEventListener('click', async () => {
            const newPrizePool = parseInt(prizePoolInput.value);
            const newFlowerPrice = parseInt(flowerPriceInput.value);

            if(isNaN(newPrizePool) || isNaN(newFlowerPrice)) {
                alert("กรุณาใส่ค่าเป็นตัวเลขเท่านั้น");
                return;
            }

            state.gameSettings.prizePool = newPrizePool;
            state.gameSettings.flowerPrice = newFlowerPrice;
            
            await saveData('settings', 'gameConfig', state.gameSettings);
            updateUI();
            alert("บันทึกการตั้งค่าเรียบร้อยแล้ว");
        });

        addCreditBtn.addEventListener('click', async () => {
            const targetUserId = creditUserIdInput.value;
            const amount = parseInt(creditAmountInput.value);

            if (!targetUserId || isNaN(amount) || amount <= 0) {
                alert("กรุณาใส่ User ID และจำนวนเงินให้ถูกต้อง");
                return;
            }

            const targetUserData = await loadData('users', targetUserId);
            if (!targetUserData) {
                alert("ไม่พบ User ID นี้ในระบบ");
                return;
            }

            const newPoints = (targetUserData.susanPoints || 0) + amount;
            await saveData('users', targetUserId, { susanPoints: newPoints });
            
            creditUserIdInput.value = '';
            creditAmountInput.value = '';
            alert(`เติมเครดิต ${amount} คะแนนให้ User ID: ${targetUserId} สำเร็จ!`);
        });

        // --- Initial Load ---
        async function initializeApp() {
            const settings = await loadData('settings', 'gameConfig');
            if (settings) {
                state.gameSettings = settings;
            }
            updateUI();
        }

        initializeApp();
    };
    </script>
</body>
</html>
